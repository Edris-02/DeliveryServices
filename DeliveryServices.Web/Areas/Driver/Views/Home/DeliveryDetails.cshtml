@model DeliveryServices.Models.Orders
@{
    ViewData["Title"] = $"Delivery #{Model.Id}";
    var statusBadge = Model.Status switch
    {
  DeliveryServices.Models.OrderStatus.Pending => "bg-warning",
  DeliveryServices.Models.OrderStatus.PickedUp => "bg-info",
  DeliveryServices.Models.OrderStatus.InTransit => "bg-primary",
        DeliveryServices.Models.OrderStatus.Delivered => "bg-success",
        DeliveryServices.Models.OrderStatus.Cancelled => "bg-danger",
        _ => "bg-secondary"
    };
}

@section PageHeader {
<div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
      <li class="breadcrumb-item"><a asp-action="Index">Dashboard</a></li>
            <li class="breadcrumb-item"><a asp-action="Deliveries">Deliveries</a></li>
     <li class="breadcrumb-item active">Order #@Model.Id</li>
 </ol>
      </nav>
        <div class="d-flex justify-content-between align-items-center">
            <div>
      <h1 class="h3 mb-0">Delivery Order #@Model.Id</h1>
                <p class="text-muted mb-0">Created: @Model.CreatedAt.ToString("yyyy/MM/dd HH:mm")</p>
            </div>
            <span class="badge @statusBadge fs-6">@Model.Status</span>
  </div>
    </div>
}

<div class="row g-4">
    <!-- Order Information -->
    <div class="col-lg-8">
        <!-- Customer Information -->
        <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="bi bi-person-circle text-primary"></i> Customer Information</h5>
      </div>
            <div class="card-body">
     <div class="row g-3">
               <div class="col-md-6">
        <label class="text-muted small">Name</label>
          <p class="mb-0"><strong>@Model.CustomerName</strong></p>
    </div>
              <div class="col-md-6">
            <label class="text-muted small">Phone</label>
<p class="mb-0">
       <a href="tel:@Model.CustomerPhone" class="text-decoration-none">
          <i class="bi bi-telephone"></i> @Model.CustomerPhone
        </a>
       </p>
               </div>
      <div class="col-12">
     <label class="text-muted small">Delivery Address</label>
    <p class="mb-0">
          <i class="bi bi-geo-alt text-danger"></i> 
      <strong>@Model.CustomerAddress</strong>
             </p>
           </div>
        </div>
       </div>
    </div>

     <!-- Merchant Information -->
        @if (Model.Merchant != null)
        {
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white border-bottom">
             <h5 class="mb-0"><i class="bi bi-shop text-primary"></i> Merchant Information</h5>
      </div>
   <div class="card-body">
         <div class="row g-3">
          <div class="col-md-6">
  <label class="text-muted small">Business Name</label>
     <p class="mb-0"><strong>@Model.Merchant.Name</strong></p>
    </div>
       <div class="col-md-6">
   <label class="text-muted small">Phone</label>
     <p class="mb-0">
     <a href="tel:@Model.Merchant.PhoneNumber" class="text-decoration-none">
       <i class="bi bi-telephone"></i> @Model.Merchant.PhoneNumber
 </a>
             </p>
 </div>
          <div class="col-12">
    <label class="text-muted small">Pickup Address</label>
                <p class="mb-0">
            <i class="bi bi-geo-alt text-info"></i> 
     @Model.Merchant.Address
    </p>
       </div>
                </div>
                </div>
            </div>
     }

      <!-- Order Items -->
        <div class="card border-0 shadow-sm mb-4">
 <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="bi bi-basket text-primary"></i> Order Items</h5>
      </div>
      <div class="card-body">
      @if (Model.Items?.Any() == true)
                {
  <div class="table-responsive">
  <table class="table table-sm align-middle mb-0">
        <thead class="table-light">
             <tr>
        <th>Product</th>
 <th class="text-center">Quantity</th>
   <th class="text-end">Price</th>
  <th class="text-end">Total</th>
   </tr>
      </thead>
  <tbody>
           @foreach (var item in Model.Items)
 {
     <tr>
     <td>@item.ProductName</td>
 <td class="text-center">@item.Quantity</td>
       <td class="text-end">@item.UnitPrice.ToString("N2")</td>
 <td class="text-end"><strong>@((item.Quantity * item.UnitPrice).ToString("N2"))</strong></td>
 </tr>
      }
          </tbody>
      <tfoot class="table-light">
          <tr>
            <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
 <td class="text-end"><strong>@Model.SubTotal.ToString("N2")</strong></td>
                </tr>
         <tr>
 <td colspan="3" class="text-end"><strong>Delivery Fee:</strong></td>
                <td class="text-end"><strong>@Model.DeliveryFee.ToString("N2")</strong></td>
      </tr>
         <tr>
   <td colspan="3" class="text-end"><strong>Total:</strong></td>
          <td class="text-end"><strong class="text-success fs-5">@Model.Total.ToString("N2")</strong></td>
     </tr>
  </tfoot>
</table>
</div>
      }
  else
   {
     <p class="text-center text-muted mb-0">No items in this order</p>
       }
            </div>
    </div>
    </div>

    <!-- Status Update Section -->
    <div class="col-lg-4">
  <!-- Update Status Card -->
     <div class="card border-0 shadow-sm mb-4">
 <div class="card-header bg-white border-bottom">
      <h5 class="mb-0"><i class="bi bi-arrow-repeat text-primary"></i> Update Status</h5>
 </div>
      <div class="card-body">
    <div class="mb-3">
   <label class="text-muted small">Current Status</label>
        <p><span class="badge @statusBadge fs-6">@Model.Status</span></p>
           </div>

@if (Model.Status == DeliveryServices.Models.OrderStatus.Delivered)
      {
        <div class="alert alert-success">
       <i class="bi bi-check-circle"></i> This order has been delivered!
            @if (Model.DeliveredAt.HasValue)
  {
             <p class="mb-0 small mt-1">Delivered at: @Model.DeliveredAt.Value.ToString("yyyy/MM/dd HH:mm")</p>
   }
     </div>
    }
    else if (Model.Status == DeliveryServices.Models.OrderStatus.Cancelled)
      {
      <div class="alert alert-danger">
     <i class="bi bi-x-circle"></i> This order has been cancelled.
     </div>
   }
    else
    {
         <form asp-action="UpdateDeliveryStatus" method="post">
       <input type="hidden" name="orderId" value="@Model.Id" />
  
        <div class="mb-3">
   <label class="form-label">Select New Status</label>
       <select name="newStatus" class="form-select" required>
<option value="">-- Select Status --</option>
   @if (Model.Status == DeliveryServices.Models.OrderStatus.Pending)
      {
  <option value="@((int)DeliveryServices.Models.OrderStatus.PickedUp)">Picked Up</option>
      }
 @if (Model.Status == DeliveryServices.Models.OrderStatus.PickedUp)
     {
  <option value="@((int)DeliveryServices.Models.OrderStatus.InTransit)">In Transit</option>
  }
       @if (Model.Status == DeliveryServices.Models.OrderStatus.InTransit)
       {
         <option value="@((int)DeliveryServices.Models.OrderStatus.Delivered)">Delivered</option>
    <option value="@((int)DeliveryServices.Models.OrderStatus.Cancelled)">Cancel (Failed Delivery)</option>
  }
      </select>
 </div>

    <button type="submit" class="btn btn-primary w-100">
     <i class="bi bi-check-circle"></i> Update Status
     </button>
     </form>

      <hr />

     <div class="small text-muted">
  <p class="mb-1"><strong>Status Flow:</strong></p>
       <ol class="mb-0 ps-3">
 <li>Pending ? Picked Up</li>
   <li>Picked Up ? In Transit</li>
<li>In Transit ? Delivered</li>
        </ol>
  </div>
      }
        </div>
        </div>

      <!-- Order Timeline -->
        <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
         <h5 class="mb-0"><i class="bi bi-clock-history text-primary"></i> Timeline</h5>
            </div>
    <div class="card-body">
          <div class="timeline">
   <div class="timeline-item">
    <i class="bi bi-check-circle text-success"></i>
     <div>
              <strong>Order Created</strong>
  <p class="text-muted small mb-0">@Model.CreatedAt.ToString("yyyy/MM/dd HH:mm")</p>
                </div>
      </div>
   @if (Model.DeliveredAt.HasValue)
           {
         <div class="timeline-item">
     <i class="bi bi-check-circle text-success"></i>
   <div>
      <strong>Delivered</strong>
          <p class="text-muted small mb-0">@Model.DeliveredAt.Value.ToString("yyyy/MM/dd HH:mm")</p>
    </div>
                 </div>
       }
         </div>
    </div>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        .timeline {
      position: relative;
            padding-left: 2rem;
        }
   .timeline-item {
     position: relative;
  padding-bottom: 1.5rem;
   }
        .timeline-item i {
      position: absolute;
            left: -2rem;
          top: 0.25rem;
        }
        .timeline-item:not(:last-child)::before {
            content: '';
            position: absolute;
   left: -1.5rem;
       top: 1.5rem;
     bottom: -0.5rem;
            width: 2px;
      background-color: #dee2e6;
        }
    </style>
}
