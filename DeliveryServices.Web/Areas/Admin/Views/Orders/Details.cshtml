@model DeliveryServices.Models.Orders
@{
    ViewData["Title"] = "Order Details";
}

@section PageHeader {
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
       <h2 class="mb-1">Order #@Model.Id</h2>
   <p class="text-secondary mb-0">View and manage order details</p>
        </div>
        <div class="d-flex gap-2">
        <a href="@Url.Action("Edit", "Orders", new { id = Model.Id, area = "Admin" })" class="btn btn-outline-primary">
     <i class="bi bi-pencil"></i> Edit
         </a>
    <a href="@Url.Action("Index", "Orders", new { area = "Admin" })" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Orders
            </a>
     </div>
    </div>
}

@if (TempData["success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i> @TempData["success"]
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-triangle"></i> @TempData["error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row g-4">
    <!-- Order Info -->
    <div class="col-lg-8">
        @if (Model.Merchant != null)
  {
            <div class="card border-0 shadow-sm mb-4">
     <div class="card-header bg-transparent border-bottom">
         <h5 class="mb-0"><i class="bi bi-shop"></i> Merchant Information</h5>
                </div>
      <div class="card-body">
            <div class="row g-3">
               <div class="col-md-6">
     <label class="small text-secondary">Merchant Name</label>
           <p class="fw-semibold mb-0">@Model.Merchant.Name</p>
   </div>
            <div class="col-md-6">
  <label class="small text-secondary">Phone</label>
                <p class="fw-semibold mb-0">@Model.Merchant.PhoneNumber</p>
   </div>
        <div class="col-12">
            <label class="small text-secondary">Address</label>
       <p class="fw-semibold mb-0">@Model.Merchant.Address</p>
              </div>
        </div>
   </div>
        </div>
      }

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-transparent border-bottom">
        <h5 class="mb-0"><i class="bi bi-person"></i> Customer Information</h5>
            </div>
         <div class="card-body">
   <div class="row g-3">
  <div class="col-md-6">
             <label class="small text-secondary">Customer Name</label>
  <p class="fw-semibold mb-0">@Model.CustomerName</p>
    </div>
<div class="col-md-6">
          <label class="small text-secondary">Phone Number</label>
      <p class="fw-semibold mb-0">@Model.CustomerPhone</p>
                    </div>
           <div class="col-12">
        <label class="small text-secondary">Delivery Address</label>
          <p class="fw-semibold mb-0">@Model.CustomerAddress</p>
     </div>
    </div>
            </div>
        </div>

      <!-- Order Items -->
        <div class="card border-0 shadow-sm mb-4">
       <div class="card-header bg-transparent border-bottom d-flex justify-content-between align-items-center">
     <h5 class="mb-0"><i class="bi bi-box-seam"></i> Order Items</h5>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
    <i class="bi bi-plus-circle"></i> Add Item
                </button>
      </div>
       <div class="card-body">
    @if (Model.Items.Any())
         {
    <div class="table-responsive">
                <table class="table">
        <thead class="table-light">
     <tr>
            <th>Product</th>
     <th>SKU</th>
         <th>Description</th>
          <th class="text-end">Quantity</th>
    <th class="text-end">Unit Price</th>
    <th class="text-end">Subtotal</th>
           <th class="text-center">Actions</th>
  </tr>
                </thead>
   <tbody>
          @foreach (var item in Model.Items)
      {
<tr>
        <td><strong>@item.ProductName</strong></td>
      <td><span class="badge bg-secondary">@item.ProductSKU</span></td>
<td>@item.ProductDescription</td>
    <td class="text-end">@item.Quantity</td>
     <td class="text-end">@item.UnitPrice.ToString("N2")</td>
          <td class="text-end"><strong>@((item.Quantity * item.UnitPrice).ToString("N2"))</strong></td>
       <td class="text-center">
           <button type="button" class="btn btn-sm btn-outline-primary" 
     data-bs-toggle="modal" 
          data-bs-target="#editItemModal-@item.Id"
            title="Edit Item">
        <i class="bi bi-pencil"></i>
                 </button>
      <button type="button" class="btn btn-sm btn-outline-danger" 
data-bs-toggle="modal" 
       data-bs-target="#removeItemModal-@item.Id"
       title="Remove Item">
       <i class="bi bi-trash"></i>
          </button>
       </td>
  </tr>

         <!-- Edit Item Modal -->
      <div class="modal fade" id="editItemModal-@item.Id" tabindex="-1">
    <div class="modal-dialog">
           <div class="modal-content">
       <form method="post" asp-action="UpdateItem" asp-controller="Orders">
              <div class="modal-header">
      <h5 class="modal-title">Edit Item</h5>
   <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
           </div>
          <div class="modal-body">
     <input type="hidden" name="orderId" value="@Model.Id" />
         <input type="hidden" name="itemId" value="@item.Id" />
      
            <div class="mb-3">
       <label class="form-label">Product Name <span class="text-danger">*</span></label>
                 <input type="text" name="productName" class="form-control" value="@item.ProductName" required />
       </div>
         <div class="mb-3">
      <label class="form-label">SKU</label>
        <input type="text" name="productSKU" class="form-control" value="@item.ProductSKU" />
       </div>
        <div class="mb-3">
         <label class="form-label">Description</label>
        <textarea name="productDescription" class="form-control" rows="2">@item.ProductDescription</textarea>
      </div>
       <div class="row">
         <div class="col-md-6 mb-3">
  <label class="form-label">Quantity <span class="text-danger">*</span></label>
                <input type="number" name="quantity" class="form-control" value="@item.Quantity" min="1" required />
  </div>
        <div class="col-md-6 mb-3">
   <label class="form-label">Unit Price <span class="text-danger">*</span></label>
             <input type="number" name="unitPrice" class="form-control" value="@item.UnitPrice" step="0.01" min="0" required />
         </div>
    </div>
         </div>
   <div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
           <button type="submit" class="btn btn-primary">Save Changes</button>
         </div>
       </form>
             </div>
          </div>
      </div>

          <!-- Remove Item Modal -->
       <div class="modal fade" id="removeItemModal-@item.Id" tabindex="-1">
           <div class="modal-dialog">
        <div class="modal-content">
     <form method="post" asp-action="RemoveItem" asp-controller="Orders">
        <div class="modal-header">
 <h5 class="modal-title">Remove Item</h5>
       <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
         <div class="modal-body">
   <input type="hidden" name="orderId" value="@Model.Id" />
 <input type="hidden" name="itemId" value="@item.Id" />
<p>Are you sure you want to remove <strong>@item.ProductName</strong> from this order?</p>
        </div>
      <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
   <button type="submit" class="btn btn-danger">Remove</button>
      </div>
 </form>
              </div>
         </div>
            </div>
            }
 </tbody>
    <tfoot class="table-light">
       <tr>
        <td colspan="5" class="text-end fw-bold">Subtotal:</td>
         <td class="text-end"><h5 class="mb-0">@Model.SubTotal.ToString("N2")</h5></td>
      <td></td>
       </tr>
            <tr>
           <td colspan="5" class="text-end fw-bold">Delivery Fee:</td>
        <td class="text-end"><h5 class="mb-0 text-info">@Model.DeliveryFee.ToString("N2")</h5></td>
          <td></td>
         </tr>
               <tr>
    <td colspan="5" class="text-end fw-bold">Total:</td>
           <td class="text-end">
       <h4 class="mb-0 text-success">@Model.Total.ToString("N2")</h4>
           </td>
  <td></td>
      </tr>
 @if (Model.MerchantId.HasValue)
      {
<tr class="table-warning">
            <td colspan="5" class="text-end">
       <small class="text-secondary">Merchant Amount (Subtotal):</small>
   </td>
       <td class="text-end">
         <strong class="text-warning">@Model.MerchantAmount.ToString("N2")</strong>
</td>
        <td></td>
         </tr>
           }
        </tfoot>
        </table>
     </div>
       }
      else
        {
   <p class="text-secondary text-center py-3">No items in this order</p>
  }
       </div>
        </div>
    </div>

<!-- Status & Actions -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-transparent border-bottom">
  <h5 class="mb-0"><i class="bi bi-info-circle"></i> Order Status</h5>
            </div>
            <div class="card-body">
    <div class="mb-3">
       <label class="small text-secondary">Current Status</label>
@{
                 var statusBadge = Model.Status switch
            {
 DeliveryServices.Models.OrderStatus.Pending => "bg-warning",
       DeliveryServices.Models.OrderStatus.PickedUp => "bg-info",
  DeliveryServices.Models.OrderStatus.InTransit => "bg-primary",
         DeliveryServices.Models.OrderStatus.Delivered => "bg-success",
                  DeliveryServices.Models.OrderStatus.Cancelled => "bg-danger",
        _ => "bg-secondary"
 };
         }
           <div class="mt-1">
            <span class="badge @statusBadge fs-6">@Model.Status</span>
   </div>
    </div>

   <div class="mb-3">
    <label class="small text-secondary">Created At</label>
     <p class="mb-0">@Model.CreatedAt.ToString("yyyy/MM/dd HH:mm")</p>
             </div>

 @if (Model.DeliveredAt.HasValue)
     {
           <div class="mb-3">
           <label class="small text-secondary">Delivered At</label>
   <p class="mb-0">@Model.DeliveredAt.Value.ToString("yyyy/MM/dd HH:mm")</p>
    </div>
                }

      <hr />

      <form method="post" asp-action="UpdateStatus" asp-controller="Orders">
    <input type="hidden" name="id" value="@Model.Id" />
     <label class="form-label small text-secondary">Update Status</label>
<select name="status" class="form-select mb-2" required>
            <option value="">Select status...</option>
            @foreach (var status in Enum.GetValues<DeliveryServices.Models.OrderStatus>())
       {
     <option value="@status" selected="@(status == Model.Status)">@status</option>
        }
     </select>
              <button type="submit" class="btn btn-primary w-100">
        <i class="bi bi-check-circle"></i> Update Status
 </button>
</form>
  </div>
        </div>

        <!-- Quick Stats -->
     <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
    <div class="mb-2">
    <i class="bi bi-box-seam fs-1 text-primary"></i>
       </div>
           <h3 class="mb-1">@Model.Items.Count</h3>
     <p class="text-secondary small mb-0">Total Items</p>
        </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
 <form method="post" asp-action="AddItem" asp-controller="Orders">
            <div class="modal-header">
          <h5 class="modal-title">Add New Item</h5>
           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
              <div class="modal-body">
        <input type="hidden" name="orderId" value="@Model.Id" />
     
          <div class="mb-3">
         <label class="form-label">Product Name <span class="text-danger">*</span></label>
         <input type="text" name="productName" class="form-control" placeholder="Enter product name" required />
     </div>
         <div class="mb-3">
       <label class="form-label">SKU</label>
    <input type="text" name="productSKU" class="form-control" placeholder="Enter SKU" />
      </div>
        <div class="mb-3">
<label class="form-label">Description</label>
            <textarea name="productDescription" class="form-control" rows="2" placeholder="Enter product description"></textarea>
 </div>
             <div class="row">
 <div class="col-md-6 mb-3">
           <label class="form-label">Quantity <span class="text-danger">*</span></label>
    <input type="number" name="quantity" class="form-control" value="1" min="1" required />
 </div>
             <div class="col-md-6 mb-3">
               <label class="form-label">Unit Price <span class="text-danger">*</span></label>
        <input type="number" name="unitPrice" class="form-control" value="0.00" step="0.01" min="0" required />
 </div>
         </div>
      </div>
       <div class="modal-footer">
       <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
    </form>
        </div>
  </div>
</div>
