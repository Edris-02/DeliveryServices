@model DeliveryServices.Models.Orders
@{
    ViewData["Title"] = "Order Details";
  var statusBadge = Model.Status switch
    {
   DeliveryServices.Models.OrderStatus.Pending => "bg-warning",
     DeliveryServices.Models.OrderStatus.PickedUp => "bg-info",
DeliveryServices.Models.OrderStatus.InTransit => "bg-primary",
        DeliveryServices.Models.OrderStatus.Delivered => "bg-success",
   DeliveryServices.Models.OrderStatus.Cancelled => "bg-danger",
      _ => "bg-secondary"
    };
}

@section PageHeader {
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
     <h2 class="mb-1">Order #@Model.Id <span class="badge @statusBadge">@Model.Status</span></h2>
    <p class="text-secondary mb-0">View and manage order details</p>
        </div>
     <div class="d-flex gap-2">
     <a href="@Url.Action("Edit", "Orders", new { id = Model.Id, area = "Admin" })" class="btn btn-outline-primary">
           <i class="bi bi-pencil"></i> Edit
      </a>
  <a href="@Url.Action("Index", "Orders", new { area = "Admin" })" class="btn btn-outline-secondary">
         <i class="bi bi-arrow-left"></i> Back to Orders
       </a>
        </div>
    </div>
}

@if (TempData["success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
  <i class="bi bi-check-circle"></i> @TempData["success"]
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle"></i> @TempData["error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row g-4">
    <!-- Left Column: Order Information & Items -->
    <div class="col-lg-8">
        <!-- Merchant & Customer Info Row -->
        <div class="row g-4 mb-4">
    @if (Model.Merchant != null)
            {
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
  <div class="card-header bg-transparent border-bottom">
  <h6 class="mb-0"><i class="bi bi-shop"></i> Merchant</h6>
        </div>
        <div class="card-body">
           <div class="mb-2">
 <label class="small text-secondary">Name</label>
    <p class="fw-semibold mb-0">@Model.Merchant.Name</p>
    </div>
      <div class="mb-2">
         <label class="small text-secondary">Phone</label>
      <p class="mb-0">@Model.Merchant.PhoneNumber</p>
  </div>
<div>
           <label class="small text-secondary">Address</label>
           <p class="mb-0 small">@Model.Merchant.Address</p>
        </div>
         </div>
        </div>
         </div>
   }

            <div class="col-md-@(Model.Merchant != null ? "6" : "12")">
      <div class="card border-0 shadow-sm h-100">
           <div class="card-header bg-transparent border-bottom">
<h6 class="mb-0"><i class="bi bi-person"></i> Customer</h6>
     </div>
                  <div class="card-body">
       <div class="mb-2">
     <label class="small text-secondary">Name</label>
         <p class="fw-semibold mb-0">@Model.CustomerName</p>
               </div>
     <div class="mb-2">
        <label class="small text-secondary">Phone</label>
           <p class="mb-0">@Model.CustomerPhone</p>
   </div>
 <div>
         <label class="small text-secondary">Delivery Address</label>
   <p class="mb-0 small">@Model.CustomerAddress</p>
 </div>
       </div>
     </div>
</div>
        </div>

        <!-- Order Items -->
  <div class="card border-0 shadow-sm">
          <div class="card-header bg-transparent border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-box-seam"></i> Order Items</h5>
     <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
         <i class="bi bi-plus-circle"></i> Add Item
    </button>
            </div>
            <div class="card-body p-0">
   @if (Model.Items.Any())
             {
    <div class="table-responsive">
          <table class="table table-hover mb-0">
   <thead class="table-light">
                 <tr>
                <th>Product</th>
            <th>SKU</th>
   <th>Description</th>
         <th class="text-end">Qty</th>
    <th class="text-end">Price</th>
      <th class="text-end">Subtotal</th>
       <th class="text-center">Status</th>
      <th class="text-center">Actions</th>
   </tr>
 </thead>
       <tbody>
        @foreach (var item in Model.Items)
          {
         var itemStatusBadge = item.Status switch
     {
         DeliveryServices.Models.OrderItemStatus.Pending => "bg-warning",
  DeliveryServices.Models.OrderItemStatus.Delivered => "bg-success",
             DeliveryServices.Models.OrderItemStatus.Cancelled => "bg-danger",
        _ => "bg-secondary"
             };

             <tr class="@(item.Status == DeliveryServices.Models.OrderItemStatus.Cancelled ? "text-decoration-line-through text-muted" : "")">
     <td><strong>@item.ProductName</strong></td>
    <td>
 @if (!string.IsNullOrEmpty(item.ProductSKU))
    {
      <span class="badge bg-secondary">@item.ProductSKU</span>
                 }
         else
          {
    <span class="text-muted">-</span>
     }
   </td>
  <td class="small">@(item.ProductDescription ?? "-")</td>
     <td class="text-end">@item.Quantity</td>
   <td class="text-end">@item.UnitPrice.ToString("C")</td>
    <td class="text-end"><strong>@((item.Quantity * item.UnitPrice).ToString("C"))</strong></td>
        <td class="text-center">
     <span class="badge @itemStatusBadge">@item.Status</span>
             </td>
     <td class="text-center">
       <div class="btn-group" role="group">
          <button type="button" class="btn btn-sm btn-outline-primary" 
          data-bs-toggle="modal" 
   data-bs-target="#editItemModal-@item.Id"
   title="Edit Item">
    <i class="bi bi-pencil"></i>
    </button>
     <button type="button" class="btn btn-sm btn-outline-info" 
          data-bs-toggle="modal" 
data-bs-target="#statusItemModal-@item.Id"
    title="Update Status">
          <i class="bi bi-arrow-repeat"></i>
 </button>
           <button type="button" class="btn btn-sm btn-outline-danger" 
           data-bs-toggle="modal" 
     data-bs-target="#removeItemModal-@item.Id"
         title="Remove Item">
       <i class="bi bi-trash"></i>
            </button>
             </div>
         </td>
   </tr>

     <!-- Edit Item Modal -->
        <div class="modal fade" id="editItemModal-@item.Id" tabindex="-1">
         <div class="modal-dialog">
               <div class="modal-content">
          <form method="post" asp-action="UpdateItem" asp-controller="Orders">
      <div class="modal-header">
           <h5 class="modal-title">Edit Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
       <div class="modal-body">
                 <input type="hidden" name="orderId" value="@Model.Id" />
               <input type="hidden" name="itemId" value="@item.Id" />
      
  <div class="mb-3">
<label class="form-label">Product Name <span class="text-danger">*</span></label>
         <input type="text" name="productName" class="form-control" value="@item.ProductName" required />
      </div>
                <div class="mb-3">
              <label class="form-label">SKU</label>
 <input type="text" name="productSKU" class="form-control" value="@item.ProductSKU" />
            </div>
       <div class="mb-3">
          <label class="form-label">Description</label>
           <textarea name="productDescription" class="form-control" rows="2">@item.ProductDescription</textarea>
  </div>
       <div class="row">
  <div class="col-md-6 mb-3">
         <label class="form-label">Quantity <span class="text-danger">*</span></label>
 <input type="number" name="quantity" class="form-control" value="@item.Quantity" min="1" required />
      </div>
         <div class="col-md-6 mb-3">
   <label class="form-label">Unit Price <span class="text-danger">*</span></label>
           <input type="number" name="unitPrice" class="form-control" value="@item.UnitPrice" step="0.01" min="0" required />
       </div>
                </div>
             </div>
      <div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
   <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
        </form>
           </div>
               </div>
           </div>

  <!-- Update Item Status Modal -->
        <div class="modal fade" id="statusItemModal-@item.Id" tabindex="-1">
  <div class="modal-dialog">
          <div class="modal-content">
<form method="post" asp-action="UpdateItemStatus" asp-controller="Orders">
       <div class="modal-header">
     <h5 class="modal-title">Update Item Status</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
         </div>
         <div class="modal-body">
          <input type="hidden" name="orderId" value="@Model.Id" />
     <input type="hidden" name="itemId" value="@item.Id" />
     
      <p><strong>Item:</strong> @item.ProductName</p>
    <p><strong>Current Status:</strong> <span class="badge @itemStatusBadge">@item.Status</span></p>

         <div class="mb-3">
               <label class="form-label">New Status <span class="text-danger">*</span></label>
            <select name="status" class="form-select" required>
       @foreach (var status in Enum.GetValues<DeliveryServices.Models.OrderItemStatus>())
       {
     <option value="@status" selected="@(status == item.Status)">@status</option>
   }
    </select>
            </div>
           
          <div class="alert alert-info mb-0">
        <small>
    <strong>Note:</strong> Only delivered items are included in the order subtotal and merchant balance.
       </small>
          </div>
     </div>
        <div class="modal-footer">
             <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
 <button type="submit" class="btn btn-primary">Update Status</button>
      </div>
    </form>
               </div>
        </div>
       </div>

  <!-- Remove Item Modal -->
 <div class="modal fade" id="removeItemModal-@item.Id" tabindex="-1">
     <div class="modal-dialog">
          <div class="modal-content">
      <form method="post" asp-action="RemoveItem" asp-controller="Orders">
       <div class="modal-header">
      <h5 class="modal-title">Remove Item</h5>
       <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
<div class="modal-body">
       <input type="hidden" name="orderId" value="@Model.Id" />
           <input type="hidden" name="itemId" value="@item.Id" />
     <p>Are you sure you want to remove <strong>@item.ProductName</strong> from this order?</p>
     </div>
        <div class="modal-footer">
               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-danger">Remove</button>
         </div>
     </form>
     </div>
               </div>
             </div>
          }
      </tbody>
    <tfoot class="table-light">
           <tr>
             <td colspan="5" class="text-end">
       <small class="text-secondary">Items: @Model.Items.Count total 
               (@Model.DeliveredItemsCount delivered, @Model.PendingItemsCount pending, @Model.CancelledItemsCount cancelled)
    </small>
     </td>
  <td colspan="3"></td>
         </tr>
         <tr>
       <td colspan="5" class="text-end fw-bold">Subtotal (Delivered Items):</td>
       <td class="text-end"><h5 class="mb-0">@Model.SubTotal.ToString("C")</h5></td>
      <td colspan="2"></td>
          </tr>
    <tr>
    <td colspan="5" class="text-end fw-bold">Delivery Fee:</td>
           <td class="text-end"><h5 class="mb-0 text-info">@Model.DeliveryFee.ToString("C")</h5></td>
                <td colspan="2"></td>
     </tr>
 <tr>
       <td colspan="5" class="text-end fw-bold">Total:</td>
    <td class="text-end">
                 <h4 class="mb-0 text-success">@Model.Total.ToString("C")</h4>
          </td>
       <td colspan="2"></td>
      </tr>
      @if (Model.MerchantId.HasValue)
      {
       <tr class="table-warning">
       <td colspan="5" class="text-end">
        <small class="text-secondary">Merchant Amount (Delivered Items Only):</small>
 </td>
        <td class="text-end">
       <strong class="text-warning">@Model.MerchantAmount.ToString("C")</strong>
  </td>
 <td colspan="2"></td>
         </tr>
             }
           </tfoot>
      </table>
             </div>
       }
       else
             {
       <div class="text-center py-5 text-secondary">
      <i class="bi bi-inbox display-4"></i>
      <p class="mt-2">No items in this order</p>
 <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
     <i class="bi bi-plus-circle"></i> Add First Item
        </button>
        </div>
                }
      </div>
        </div>
    </div>

    <!-- Right Column: Status, Actions & Summary -->
  <div class="col-lg-4">
        <!-- Order Status & Actions -->
        <div class="card border-0 shadow-sm mb-4">
  <div class="card-header bg-transparent border-bottom">
          <h6 class="mb-0"><i class="bi bi-info-circle"></i> Order Status & Actions</h6>
      </div>
            <div class="card-body">
       <div class="mb-3">
  <label class="small text-secondary">Current Status</label>
      <div class="mt-1">
             <span class="badge @statusBadge fs-6">@Model.Status</span>
        </div>
     </div>

        <div class="mb-3">
    <label class="small text-secondary">Created At</label>
        <p class="mb-0">@Model.CreatedAt.ToString("MMM dd, yyyy HH:mm")</p>
     </div>

        @if (Model.DeliveredAt.HasValue)
       {
       <div class="mb-3">
           <label class="small text-secondary">Delivered At</label>
           <p class="mb-0">@Model.DeliveredAt.Value.ToString("MMM dd, yyyy HH:mm")</p>
     </div>
       }

     <hr />

     <form method="post" asp-action="UpdateStatus" asp-controller="Orders">
   <input type="hidden" name="id" value="@Model.Id" />
       <label class="form-label small text-secondary fw-bold">Update Order Status</label>
       <select name="status" class="form-select mb-2" required>
        <option value="">Select status...</option>
      @foreach (var status in Enum.GetValues<DeliveryServices.Models.OrderStatus>())
          {
                  <option value="@status" selected="@(status == Model.Status)">@status</option>
 }
  </select>
     <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-check-circle"></i> Update Status
   </button>
              </form>
            </div>
        </div>

        <!-- Item Statistics -->
        <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-transparent border-bottom">
     <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Item Statistics</h6>
     </div>
    <div class="card-body">
            <div class="mb-3 text-center pb-3 border-bottom">
      <i class="bi bi-box-seam fs-1 text-primary"></i>
             <h3 class="mb-1">@Model.Items.Count</h3>
       <p class="text-secondary small mb-0">Total Items</p>
    </div>

  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-secondary">
  <i class="bi bi-check-circle text-success"></i> Delivered
        </span>
       <span class="badge bg-success">@Model.DeliveredItemsCount</span>
             </div>

    <div class="d-flex justify-content-between align-items-center mb-2">
 <span class="text-secondary">
   <i class="bi bi-clock text-warning"></i> Pending
          </span>
         <span class="badge bg-warning">@Model.PendingItemsCount</span>
   </div>

         <div class="d-flex justify-content-between align-items-center">
        <span class="text-secondary">
       <i class="bi bi-x-circle text-danger"></i> Cancelled
      </span>
   <span class="badge bg-danger">@Model.CancelledItemsCount</span>
                </div>
    </div>
        </div>

        <!-- Financial Summary -->
        <div class="card border-0 shadow-sm">
  <div class="card-header bg-transparent border-bottom">
  <h6 class="mb-0"><i class="bi bi-currency-dollar"></i> Financial Summary</h6>
     </div>
       <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
   <span class="text-secondary">Subtotal</span>
       <strong>@Model.SubTotal.ToString("C")</strong>
      </div>
    <small class="text-muted d-block mb-2">(@Model.DeliveredItemsCount delivered items only)</small>

       <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
        <span class="text-secondary">Delivery Fee</span>
   <span class="text-info fw-bold">@Model.DeliveryFee.ToString("C")</span>
      </div>

       <div class="d-flex justify-content-between align-items-center mb-3">
      <span class="fw-bold fs-5">Total</span>
          <h4 class="mb-0 text-success">@Model.Total.ToString("C")</h4>
         </div>

       @if (Model.MerchantId.HasValue && Model.Merchant != null)
          {
      <div class="alert alert-warning mb-0 p-2">
  <small>
          <strong><i class="bi bi-shop"></i> Merchant Amount:</strong><br />
   <span class="fs-6">@Model.MerchantAmount.ToString("C")</span>
            <span class="text-muted d-block">(Subtotal only - Delivered items)</span>
        </small>
     </div>
     }
         </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
       <form method="post" asp-action="AddItem" asp-controller="Orders">
    <div class="modal-header">
    <h5 class="modal-title">Add New Item</h5>
           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
            <div class="modal-body">
         <input type="hidden" name="orderId" value="@Model.Id" />
               
        <div class="mb-3">
      <label class="form-label">Product Name <span class="text-danger">*</span></label>
      <input type="text" name="productName" class="form-control" placeholder="Enter product name" required />
   </div>
                <div class="mb-3">
        <label class="form-label">SKU</label>
  <input type="text" name="productSKU" class="form-control" placeholder="Enter SKU" />
         </div>
       <div class="mb-3">
        <label class="form-label">Description</label>
          <textarea name="productDescription" class="form-control" rows="2" placeholder="Enter product description"></textarea>
              </div>
     <div class="row">
      <div class="col-md-6 mb-3">
<label class="form-label">Quantity <span class="text-danger">*</span></label>
    <input type="number" name="quantity" class="form-control" value="1" min="1" required />
         </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Unit Price <span class="text-danger">*</span></label>
      <input type="number" name="unitPrice" class="form-control" value="0.00" step="0.01" min="0" required />
       </div>
   </div>
            </div>
                <div class="modal-footer">
             <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
         <button type="submit" class="btn btn-primary">Add Item</button>
   </div>
            </form>
   </div>
    </div>
</div>
